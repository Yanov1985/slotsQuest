# üéØ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –º–µ—Ö–∞–Ω–∏–∫ –∏ —Ç–µ–º–∞—Ç–∏–∫

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞:

- –í –ë–î –±—ã–ª–æ 5 —Å–ª–æ—Ç–æ–≤, 94 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, 6 –º–µ—Ö–∞–Ω–∏–∫, 241 —Ç–µ–º–∞—Ç–∏–∫–∞
- **–ù–û**: –í—Å–µ —Å–≤—è–∑–∏ –±—ã–ª–∏ –ø—É—Å—Ç—ã–º–∏ (0 –∑–∞–ø–∏—Å–µ–π –≤ `slot_mechanics`, `slot_bonuses`, `slot_themes`)
- –í –∞–¥–º–∏–Ω–∫–µ –∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –º–µ—Ö–∞–Ω–∏–∫–∏ –∏ —Ç–µ–º–∞—Ç–∏–∫–∏ —Å–ª–æ—Ç–æ–≤

## üîç –ü—Ä–∏—á–∏–Ω–∞

1. **–°—Ö–µ–º–∞ Prisma** –ø–æ—Å–ª–µ –±—ç–∫–∞–ø–∞ –≤–µ—Ä–Ω—É–ª–∞—Å—å –∫ —Å—Ç–∞—Ä–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é - –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –º–æ–¥–µ–ª—å `slot_themes` –¥–ª—è many-to-many —Å–≤—è–∑–∏
2. **Backend —Å–µ—Ä–≤–∏—Å—ã** –Ω–µ –∏–º–µ–ª–∏ –ª–æ–≥–∏–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤—è–∑–µ–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ª–æ—Ç–æ–≤
3. **Frontend** –Ω–µ –º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, —Ç.–∫. backend –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏/—Ç–µ–º–∞—Ç–∏–∫–∏

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏–ª–∏ Prisma —Å—Ö–µ–º—É

```prisma
// –î–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è many-to-many —Å–≤—è–∑–∏
model slot_themes {
  id         String   @id @default(cuid())
  slot_id    String
  theme_id   String
  created_at DateTime @default(now())

  slots      slots    @relation(fields: [slot_id], references: [id], onDelete: Cascade)
  themes     themes   @relation(fields: [theme_id], references: [id], onDelete: Cascade)

  @@unique([slot_id, theme_id])
  @@index([slot_id], map: "idx_slot_themes_slot_id")
  @@index([theme_id], map: "idx_slot_themes_theme_id")
}

// –û–±–Ω–æ–≤–∏–ª–∏ –º–æ–¥–µ–ª—å slots
model slots {
  // ...
  theme_id    String? // Deprecated: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ slotThemes –¥–ª—è many-to-many —Å–≤—è–∑–∏
  slotThemes  slot_themes[] // –ù–æ–≤–∞—è many-to-many —Å–≤—è–∑—å —Å —Ç–µ–º–∞–º–∏
  // ...
}

// –û–±–Ω–æ–≤–∏–ª–∏ –º–æ–¥–µ–ª—å themes
model themes {
  // ...
  slots_deprecated  slots[]       @relation("DeprecatedTheme") // –°—Ç–∞—Ä–∞—è —Å–≤—è–∑—å
  slotThemes       slot_themes[] // –ù–æ–≤–∞—è many-to-many —Å–≤—è–∑—å
  // ...
}
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏–ª–∏ `themes.service.ts`

–ó–∞–º–µ–Ω–∏–ª–∏ –≤—Å–µ `slots` –Ω–∞ `slotThemes`:

**–î–æ:**

```typescript
_count: {
  select: {
    slots: true, // ‚ùå –°—Ç–∞—Ä–∞—è —Å–≤—è–∑—å
  },
}
```

**–ü–æ—Å–ª–µ:**

```typescript
_count: {
  select: {
    slotThemes: true, // ‚úÖ –ù–æ–≤–∞—è —Å–≤—è–∑—å many-to-many
  },
}
```

**–ú–µ—Ç–æ–¥ `findSlotsByTheme` –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω:**

```typescript
async findSlotsByTheme(themeId: string) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é many-to-many —Å–≤—è–∑—å —á–µ—Ä–µ–∑ slot_themes
  const slotThemes = await this.prisma.slot_themes.findMany({
    where: {
      theme_id: themeId,
      slots: {
        is_active: true,
      },
    },
    include: {
      slots: {
        include: {
          providers: true,
          slot_categories: true,
        },
      },
    },
    orderBy: {
      slots: {
        created_at: 'desc',
      },
    },
  });

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ —Å–ª–æ—Ç–æ–≤ –∏–∑ —Å–≤—è–∑–µ–π
  return slotThemes.map(st => st.slots);
}
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏–ª–∏ `slots.service.ts`

**–ó–∞–º–µ–Ω–∏–ª–∏ –≤—Å–µ `themes: true` –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:**

```typescript
slotThemes: {
  include: {
    themes: true,
  },
},
```

**–î–æ–±–∞–≤–∏–ª–∏ –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤—è–∑–µ–π –≤ `createSlot`:**

```typescript
// –®–ê–ì 1: –°–æ–∑–¥–∞—ë–º —Å–ª–æ—Ç –±–µ–∑ —Å–≤—è–∑–µ–π
const slot = await this.prisma.slots.create({
  data: createData,
});

// –®–ê–ì 2: –°–æ–∑–¥–∞—ë–º —Å–≤—è–∑–∏ —Å –º–µ—Ö–∞–Ω–∏–∫–∞–º–∏
if (
  selected_mechanics &&
  Array.isArray(selected_mechanics) &&
  selected_mechanics.length > 0
) {
  await this.prisma.slot_mechanics.createMany({
    data: selected_mechanics.map((mechanic_id: string) => ({
      slot_id: slot.id,
      mechanic_id,
    })),
  });
}

// –®–ê–ì 3: –°–æ–∑–¥–∞—ë–º —Å–≤—è–∑–∏ —Å –±–æ–Ω—É—Å–∞–º–∏
if (
  selected_bonuses &&
  Array.isArray(selected_bonuses) &&
  selected_bonuses.length > 0
) {
  await this.prisma.slot_bonuses.createMany({
    data: selected_bonuses.map((bonus_id: number) => ({
      slot_id: slot.id,
      bonus_id,
    })),
  });
}

// –®–ê–ì 4: –°–æ–∑–¥–∞—ë–º —Å–≤—è–∑–∏ —Å —Ç–µ–º–∞—Ç–∏–∫–∞–º–∏ (–¥–æ 5)
if (
  selected_themes &&
  Array.isArray(selected_themes) &&
  selected_themes.length > 0
) {
  const themesToAdd = selected_themes.slice(0, 5); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 5
  await this.prisma.slot_themes.createMany({
    data: themesToAdd.map((theme_id: string) => ({
      slot_id: slot.id,
      theme_id,
    })),
  });
}

// –®–ê–ì 5: –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–ª–æ—Ç —Å–æ –≤—Å–µ–º–∏ —Å–≤—è–∑—è–º–∏
const createdSlot = await this.prisma.slots.findUnique({
  where: { id: slot.id },
  include: {
    // ... –≤—Å–µ —Å–≤—è–∑–∏
  },
});
```

**–î–æ–±–∞–≤–∏–ª–∏ –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π –≤ `updateSlot`:**

```typescript
// –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏ —Å –º–µ—Ö–∞–Ω–∏–∫–∞–º–∏
if (selected_mechanics !== undefined) {
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏
  await this.prisma.slot_mechanics.deleteMany({
    where: { slot_id: id },
  });
  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —Å–≤—è–∑–∏
  if (Array.isArray(selected_mechanics) && selected_mechanics.length > 0) {
    await this.prisma.slot_mechanics.createMany({
      data: selected_mechanics.map((mechanic_id: string) => ({
        slot_id: id,
        mechanic_id,
      })),
    });
  }
}

// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è selected_bonuses –∏ selected_themes
```

### –®–∞–≥ 4: –ü—Ä–∏–º–µ–Ω–∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

```bash
npx prisma db push --accept-data-loss
npx prisma generate
```

## üéì –ú–µ—Ç–∞—Ñ–æ—Ä–∞: –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —ç—Ç–æ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å —Ç–∏–ø–∞ Tinder:

**–°—Ç–∞—Ä–∞—è —Å—Ö–µ–º–∞ (One-to-Many):**

- –£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –û–î–ù–û —Ö–æ–±–±–∏
- –ï—Å–ª–∏ —Ç—ã –ª—é–±–∏—à—å —Ñ—É—Ç–±–æ–ª –ò –∫–∏–Ω–æ - –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –≤—ã–±–∏—Ä–∞—Ç—å —á—Ç–æ-—Ç–æ –æ–¥–Ω–æ
- ‚ùå –û—á–µ–Ω—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ!

**–ù–æ–≤–∞—è —Å—Ö–µ–º–∞ (Many-to-Many):**

- –£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ù–ï–°–ö–û–õ–¨–ö–û —Ö–æ–±–±–∏ (–¥–æ 5)
- –¢—ã –º–æ–∂–µ—à—å —É–∫–∞–∑–∞—Ç—å: —Ñ—É—Ç–±–æ–ª, –∫–∏–Ω–æ, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –º—É–∑—ã–∫–∞, –∫—É–ª–∏–Ω–∞—Ä–∏—è
- –°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–∏—Ç —ç—Ç–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ "user_hobbies" —Å–æ —Å–≤—è–∑—è–º–∏
- ‚úÖ –ì–∏–±–∫–æ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ!

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –°—Ö–µ–º–∞ Prisma –æ–±–Ω–æ–≤–ª–µ–Ω–∞
‚úÖ –¢–∞–±–ª–∏—Ü–∞ `slot_themes` —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î
‚úÖ `themes.service.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `slotThemes`
‚úÖ `slots.service.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `slotThemes`
‚úÖ –õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤—è–∑–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `createSlot`
‚úÖ –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `updateSlot`
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ (–¥–æ 5 —Ç–µ–º–∞—Ç–∏–∫)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–û—Ç–∫—Ä–æ–π –∞–¥–º–∏–Ω–∫—É** ‚Üí –°–ª–æ—Ç—ã ‚Üí –í—ã–±–µ—Ä–∏ —Å–ª–æ—Ç
2. **–í—ã–±–µ—Ä–∏ –º–µ—Ö–∞–Ω–∏–∫–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Cascading Reels", "Free Spins")
3. **–í—ã–±–µ—Ä–∏ –¥–æ 5 —Ç–µ–º–∞—Ç–∏–∫** (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–∏—Ñ–æ–ª–æ–≥–∏—è", "–î—Ä–µ–≤–Ω—è—è –ì—Ä–µ—Ü–∏—è", "–ë–æ–≥–∏")
4. **–ù–∞–∂–º–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"**
5. **–û—Ç–∫—Ä–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —á–∞—Å—Ç—å** ‚Üí –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ª–æ—Ç–∞
6. **–ü—Ä–æ–≤–µ—Ä—å Hero —Å–µ–∫—Ü–∏—é** ‚Üí –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –º–µ—Ö–∞–Ω–∏–∫–∏ –∏ —Ç–µ–º–∞—Ç–∏–∫–∏

## üìù –í–∞–∂–Ω–æ

- –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **–¥–æ 5 —Ç–µ–º–∞—Ç–∏–∫**
- –°–≤—è–∑–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `slot_themes`
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–ª–æ—Ç–∞ –≤—Å–µ —Å–≤—è–∑–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è (`onDelete: Cascade`)
- –°—Ç–∞—Ä–æ–µ –ø–æ–ª–µ `theme_id` –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ deprecated –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

## üîß –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `backend/prisma/schema.prisma` - –°—Ö–µ–º–∞ –ë–î
2. `backend/src/themes/themes.service.ts` - –°–µ—Ä–≤–∏—Å —Ç–µ–º–∞—Ç–∏–∫
3. `backend/src/slots/slots.service.ts` - –°–µ—Ä–≤–∏—Å —Å–ª–æ—Ç–æ–≤ (–ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
4. `backend/prisma/dev.db` - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞)

## ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. **–ì–∏–±–∫–æ—Å—Ç—å**: –°–ª–æ—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–º–∞—Ç–∏–∫
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å —Å–≤—è–∑–∏
3. **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å**: Cascade delete –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç "–±–∏—Ç—ã—Ö" —Å–≤—è–∑–µ–π
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ò–Ω–¥–µ–∫—Å—ã —É—Å–∫–æ—Ä—è—é—Ç –∑–∞–ø—Ä–æ—Å—ã
5. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: –Ø–≤–Ω–∞—è —Å–≤—è–∑—å —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É

---

–°–æ–∑–¥–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}
–°—Ç–∞—Ç—É—Å: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
